image: python:3.8
stages:
  - test
  - git-robot

check_schema:
  variables:
    SIIBRA_PYTHON_PATH: $CI_BUILDS_DIR/$CI_CONCURRENT_ID/siibra-python
    GIT_DEPTH: 1
    
  stage: test
  before_script: |
    echo "[DEVELOP BUILD] Using refactor_v0.4_configValidation branch. In prod, use main branch instead."
    rm -rf $SIIBRA_PYTHON_PATH
    git clone -v -b refactor_v0.4_configValidation \
      https://github.com/FZJ-INM1-BDA/siibra-python.git \
      $SIIBRA_PYTHON_PATH
    git -C $SIIBRA_PYTHON_PATH log -n 1
    pip install -r $SIIBRA_PYTHON_PATH/config_schema/requirements.txt
  script: |
    echo python $SIIBRA_PYTHON_PATH/config_schema/check_schema.py $PWD
    git -C $PWD log -n 1
    python $SIIBRA_PYTHON_PATH/config_schema/check_schema.py $PWD


region_attr_compliance:
  stage: test
  script:
    - python ./_ci/region_attr_compliance.py

push_to_mirror:
  stage: git-robot
  only:
    - master
    - tags
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - git config --global user.email "inm1-bda@fz-juelich.de"
    - git config --global user.name "inm1 bda - gitlab bot"
    - mkdir -p ~/.ssh

    # add $GITLAB_MIRROR_HOST to known hosts
    - ssh-keyscan $GITLAB_MIRROR_HOST >> gitlab-known-hosts
    - cat gitlab-known-hosts >> ~/.ssh/known_hosts
  script:
    # fetch all tags (potentially overwriting local tags to avoid clobbering)
    - git fetch --tags -f
    - git fetch origin master

    # add remote mirror
    - if ! git ls-remote ebrains > /dev/null; then git remote add ebrains https://jugitpusher:${GITLAB_MIRROR_TOKEN}@${GITLAB_MIRROR_HOST}/${GITLAB_MIRROR_REPO_PATH}; fi

    # push all tags and master to remote mirror
    - git push ebrains --tags -f
    - git push ebrains HEAD:master -f # https://forum.gitlab.com/t/src-refspec-master-does-not-match-any/24691/16

image: python:3.8
stages:
  - test
  - git-robot

before-script:
  script:
    - python -m pip install --upgrade pip

parc_version_ci:
  stage: test
  script:
    - python ./_ci/parc_version_ci.py

dataset_compliance:
  stage: test
  script:
    - python ./_ci/dataset_compliance.py

region_attr_compliance:
  stage: test
  script:
    - python ./_ci/region_attr_compliance.py

push_to_mirror:
  stage: git-robot
  only:
    - master
    - tags
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - git config --global user.email "inm1-bda@fz-juelich.de"
    - git config --global user.name "inm1 bda - gitlab bot"
    - mkdir -p ~/.ssh

    # add $GITLAB_MIRROR_HOST to known hosts
    - ssh-keyscan $GITLAB_MIRROR_HOST >> gitlab-known-hosts
    - cat gitlab-known-hosts >> ~/.ssh/known_hosts
  script:
    # fetch all tags (potentially overwriting local tags to avoid clobbering)
    - git fetch --tags -f
    - git fetch origin master

    # add remote mirror
    - if ! git ls-remote ebrains > /dev/null; then git remote add ebrains https://jugitpusher:${GITLAB_MIRROR_TOKEN}@${GITLAB_MIRROR_HOST}/${GITLAB_MIRROR_REPO_PATH}; fi

    # push all tags and master to remote mirror
    - git push ebrains --tags -f
    - git push ebrains HEAD:master -f # https://forum.gitlab.com/t/src-refspec-master-does-not-match-any/24691/16
